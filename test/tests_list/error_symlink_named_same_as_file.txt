#
#
#

FUNCTION(TEST_PRERUN)
    CMLIB_PARSE_ARGUMENTS(
        ONE_VALUE
            VERSION INSTALL_DIR
            LIBRARY_NAME
        REQUIRED
            VERSION INSTALL_DIR
            LIBRARY_NAME
        P_ARGN ${ARGN}
    )

    SET(library_name "${__LIBRARY_NAME}")
    SET(version      "${__VERSION}")
    SET(library_soname lib${library_name}.so.${version})
    SET(link_soname    lib${library_name}.so)
    INSTALL(CODE "SET(CMAKE_INSTALL_PREFIX ${CMAKE_INSTALL_PREFIX})")
    INSTALL(CODE "SET(install_dir      ${__INSTALL_DIR})")
    INSTALL(CODE "SET(link_soname      ${link_soname})")
    INSTALL(CODE "SET(library_soname   ${library_soname})")
    INSTALL(CODE "SET(link_filepath    ${install_dir}/${link_soname})")
    INSTALL(CODE "SET(library_filepath ${install_dir}/${library_soname})")
    INSTALL(CODE "SET(new_library_filepath ${__INSTALL_DIR}/${library_soname})")
    INSTALL(CODE [[
        EXECUTE_PROCESS(
            COMMAND ${CMAKE_COMMAND} -E copy "${library_filepath}" "${new_library_filepath}"
            WORKING_DIRECTORY "${CMAKE_INSTALL_PREFIX}/"
        )
        EXECUTE_PROCESS(
            COMMAND ${CMAKE_COMMAND} -E rm "${library_filepath}"
            WORKING_DIRECTORY "${CMAKE_INSTALL_PREFIX}/"
        )
        EXECUTE_PROCESS(
            COMMAND ${CMAKE_COMMAND} -E create_symlink "../../${new_library_filepath}" ${library_filepath}
            WORKING_DIRECTORY "${CMAKE_INSTALL_PREFIX}/"
        )
    ]])
ENDFUNCTION()